{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="border-bottom pb-2"><i class="fas fa-clipboard-check me-2"></i>Manutenções Realizadas</h2>
            <a href="{{ url_for('maintenance.schedule_list') }}" class="btn btn-primary">
                <i class="fas fa-calendar-alt me-2"></i>Ver Agendamentos
            </a>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Histórico de Manutenções</h5>
    </div>
    <div class="card-body">
        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">Todos</button>
                    <button type="button" class="btn btn-outline-success" data-filter="completed">Concluídos</button>
                    <button type="button" class="btn btn-outline-warning" data-filter="in_progress">Em Andamento</button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="input-group w-50 ms-auto">
                    <input type="text" id="searchRecords" class="form-control" placeholder="Pesquisar...">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="maintenanceRecordsTable">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Equipamento</th>
                        <th>Localização</th>
                        <th>Técnico</th>
                        <th>Duração</th>
                        <th>Status</th>
                        <th>Problemas</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% if records %}
                        {% for record in records %}
                        <tr data-status="{{ record.status }}" data-issues="{{ 'yes' if record.issues_found else 'no' }}">
                            <td>{{ record.start_time|format_date }}</td>
                            <td>
                                <a href="{{ url_for('equipment.view', equipment_id=record.equipment_id) }}">
                                    {{ record.equipment.identification_number }}
                                </a>
                            </td>
                            <td>{{ record.equipment.location_building }}, Andar {{ record.equipment.location_floor }}</td>
                            <td>{{ record.technician.first_name }} {{ record.technician.last_name }}</td>
                            <td>
                                {% if record.end_time %}
                                    {{ ((record.end_time - record.start_time).total_seconds() / 3600)|round(1) }} horas
                                {% else %}
                                    Em andamento
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if record.status == 'completed' else 'warning' }}">
                                    {{ 'Concluído' if record.status == 'completed' else 'Em Andamento' }}
                                </span>
                            </td>
                            <td>
                                {% if record.issues_found %}
                                    <span class="badge bg-danger">Problemas Encontrados</span>
                                {% else %}
                                    <span class="badge bg-success">Sem Problemas</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('maintenance.view_record', record_id=record.id) }}" class="btn btn-sm btn-info" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if record.schedule_id %}
                                    <a href="{{ url_for('maintenance.view_schedule', schedule_id=record.schedule_id) }}" class="btn btn-sm btn-primary" title="Ver Agendamento">
                                        <i class="fas fa-calendar-alt"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr id="noRecordsRow">
                            <td colspan="8" class="text-center">Nenhum registro de manutenção encontrado.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Mensagem para quando não houver resultados na filtragem -->
        <div id="noFilterResults" class="alert alert-info text-center d-none">
            <i class="fas fa-info-circle me-2"></i>Nenhum registro encontrado com os filtros atuais.
        </div>
    </div>
</div>

{% if current_user.is_admin() or current_user.is_supervisor() %}
<div class="row">
    <div class="col">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Estatísticas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">{{ records|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                                <p class="mb-0">Concluídos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning">{{ records|selectattr('status', 'equalto', 'in_progress')|list|length }}</h3>
                                <p class="mb-0">Em Andamento</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger">{{ records|selectattr('issues_found')|list|length }}</h3>
                                <p class="mb-0">Problemas Encontrados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                {% set completed_records = records|selectattr('status', 'equalto', 'completed')|selectattr('end_time', 'defined')|list %}
                                {% set total_hours = namespace(value=0) %}
                                {% for record in completed_records %}
                                    {% set total_hours.value = total_hours.value + ((record.end_time - record.start_time).total_seconds() / 3600) %}
                                {% endfor %}
                                {% if completed_records|length > 0 %}
                                    <h3 class="text-info">{{ (total_hours.value / completed_records|length)|round(1) }}</h3>
                                {% else %}
                                    <h3 class="text-info">0</h3>
                                {% endif %}
                                <p class="mb-0">Média de Horas</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Tendências Recentes</h6>
                        <p><i class="fas fa-info-circle me-2"></i>As manutenções estão sendo concluídas eficientemente com um tempo médio de conclusão abaixo dos padrões do setor.</p>
                        <p><i class="fas fa-exclamation-triangle me-2"></i>Existem equipamentos com problemas recorrentes que podem precisar de manutenção mais abrangente.</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Recomendações</h6>
                        <p><i class="fas fa-check-circle me-2"></i>Continuar com o cronograma regular de manutenção para todos os equipamentos.</p>
                        <p><i class="fas fa-tools me-2"></i>Considerar a atualização do plano de manutenção para equipamentos com problemas recorrentes.</p>
                        <p><i class="fas fa-chart-line me-2"></i>Ver <a href="{{ url_for('reports.index') }}">relatórios detalhados</a> para mais informações.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filtros de status
        const filterButtons = document.querySelectorAll('[data-filter]');
        const searchInput = document.getElementById('searchRecords');
        const tableRows = document.querySelectorAll('#maintenanceRecordsTable tbody tr:not(#noRecordsRow)');
        const noFilterResults = document.getElementById('noFilterResults');
        
        // Função para aplicar filtros
        function applyFilters() {
            const activeFilter = document.querySelector('[data-filter].active').getAttribute('data-filter');
            const searchTerm = searchInput.value.toLowerCase();
            let visibleRows = 0;
            
            tableRows.forEach(row => {
                const status = row.getAttribute('data-status');
                const rowText = row.textContent.toLowerCase();
                
                const matchesFilter = activeFilter === 'all' || status === activeFilter;
                const matchesSearch = rowText.includes(searchTerm);
                
                if (matchesFilter && matchesSearch) {
                    row.classList.remove('d-none');
                    visibleRows++;
                } else {
                    row.classList.add('d-none');
                }
            });
            
            // Mostrar mensagem quando não houver resultados
            if (visibleRows === 0 && tableRows.length > 0) {
                noFilterResults.classList.remove('d-none');
            } else {
                noFilterResults.classList.add('d-none');
            }
        }
        
        // Event listeners para filtros de botão
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                applyFilters();
            });
        });
        
        // Event listener para pesquisa
        searchInput.addEventListener('input', applyFilters);
    });
</script>
{% endblock %}
