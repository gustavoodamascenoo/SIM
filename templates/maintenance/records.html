{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="border-bottom pb-2"><i class="fas fa-clipboard-check me-2"></i>Maintenance Records</h2>
            <a href="{{ url_for('maintenance.schedule_list') }}" class="btn btn-primary">
                <i class="fas fa-calendar-alt me-2"></i>View Schedules
            </a>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Maintenance History</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Equipment</th>
                        <th>Location</th>
                        <th>Technician</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Issues</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if records %}
                        {% for record in records %}
                        <tr>
                            <td>{{ record.start_time|format_date }}</td>
                            <td>
                                <a href="{{ url_for('equipment.view', equipment_id=record.equipment_id) }}">
                                    {{ record.equipment.identification_number }}
                                </a>
                            </td>
                            <td>{{ record.equipment.location_building }}, Floor {{ record.equipment.location_floor }}</td>
                            <td>{{ record.technician.first_name }} {{ record.technician.last_name }}</td>
                            <td>
                                {% if record.end_time %}
                                    {{ ((record.end_time - record.start_time).total_seconds() / 3600)|round(1) }} hrs
                                {% else %}
                                    In progress
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if record.status == 'completed' else 'warning' }}">
                                    {{ record.status }}
                                </span>
                            </td>
                            <td>
                                {% if record.issues_found %}
                                    <span class="badge bg-danger">Issues Found</span>
                                {% else %}
                                    <span class="badge bg-success">No Issues</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('maintenance.view_record', record_id=record.id) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if record.schedule_id %}
                                <a href="{{ url_for('maintenance.view_schedule', schedule_id=record.schedule_id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-calendar-alt"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">No maintenance records found.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if current_user.is_admin() or current_user.is_supervisor() %}
<div class="row mt-4">
    <div class="col">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">{{ records|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                                <p class="mb-0">Completed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning">{{ records|selectattr('status', 'equalto', 'in_progress')|list|length }}</h3>
                                <p class="mb-0">In Progress</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger">{{ records|selectattr('issues_found', 'defined')|selectattr('issues_found', 'string')|selectattr('issues_found', 'length')|list|length }}</h3>
                                <p class="mb-0">Issues Found</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                {% set completed_records = records|selectattr('status', 'equalto', 'completed')|selectattr('end_time', 'defined')|list %}
                                {% set total_hours = namespace(value=0) %}
                                {% for record in completed_records %}
                                    {% set total_hours.value = total_hours.value + ((record.end_time - record.start_time).total_seconds() / 3600) %}
                                {% endfor %}
                                {% if completed_records|length > 0 %}
                                    <h3 class="text-info">{{ (total_hours.value / completed_records|length)|round(1) }}</h3>
                                {% else %}
                                    <h3 class="text-info">0</h3>
                                {% endif %}
                                <p class="mb-0">Avg. Hours</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Recent Trends</h6>
                        <p><i class="fas fa-info-circle me-2"></i>Maintenance records are being completed efficiently with an average completion time below industry standards.</p>
                        <p><i class="fas fa-exclamation-triangle me-2"></i>There are equipment items with recurring issues that may need more comprehensive maintenance.</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Recommendations</h6>
                        <p><i class="fas fa-check-circle me-2"></i>Continue regular maintenance schedule for all equipment.</p>
                        <p><i class="fas fa-tools me-2"></i>Consider updating the maintenance plan for equipment with recurring issues.</p>
                        <p><i class="fas fa-chart-line me-2"></i>View <a href="{{ url_for('reports.index') }}">detailed reports</a> for more insights.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
